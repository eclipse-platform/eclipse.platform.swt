# This is the main maven workflow for SWT.

# You can run this locally to test changes with the act command https://nektosact.com/
# For example, to run all GTK4 tests:
#   act -j build-linux --matrix java:21 --matrix gtk:gtk4 --artifact-server-path $PWD/.artifacts
# You may need to download runners on first run, act will ask but if you
# want the big runner there is no progress as it downloads, so you can pull it with
# docker directly:
#   docker pull catthehacker/ubuntu:full-latest

name: SWT Matrix Build
concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    types: [opened, reopened, synchronize, labeled]

jobs:
  event_file:
    name: "Event File"
    runs-on: ubuntu-latest
    steps:
    - name: Upload
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: Event File
        path: ${{ github.event_path }}

  changes:
    name: Detect changed paths
    runs-on: ubuntu-latest
    outputs:
      # Lint warnings are expected in this block
      # https://github.com/dorny/paths-filter/issues/223#issuecomment-2463309889
      win32: ${{ steps.filter.outputs.win32  || 'false' }}
      gtk:   ${{ steps.filter.outputs.gtk    || 'false' }}
      cocoa: ${{ steps.filter.outputs.cocoa  || 'false' }}
      md:    ${{ steps.filter.outputs.md     || 'false' }}
      other: ${{ steps.filter.outputs.other  || 'false' }}
    steps:
      - name: Paths filter (PRs only)
        if: github.event.pull_request.base
        # dorney/paths-filter is out of date, so use this fork with
        # a specific fix for missing predicate-quantifier in action's
        # inputs
        # https://github.com/dorny/paths-filter/pull/226#issuecomment-2805358761
        uses: petermetz/paths-filter@5ee2f5d4cf5d7bdd998a314a42da307e2ae1639d
        id: filter
        with:
          predicate-quantifier: 'every'
          filters: |
            win32:
              - '**/win32/**'
            gtk:
              - '**/gtk/**'
            cocoa:
              - '**/cocoa/**'
            md:
              - '**/*.md'
            jenkins:
              - 'Jenkinsfile'
            # "other" = anything not matching the above buckets
            other:
              - '**'
              - '!**/win32/**'
              - '!**/gtk/**'
              - '!**/cocoa/**'
              - '!**/*.md'
              - '!Jenkinsfile'

  build-linux:
    name: Build (Linux)
    needs: changes
    # push => always; PR => run if gtk changed OR "other" changed (run-everything case)
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.gtk == 'true' || needs.changes.outputs.other == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        java: ['21']
        gtk: [gtk3, gtk4]
        gdk_backend: [x11, wayland]
        exclude:
          - gtk: gtk3
            gdk_backend: wayland
    uses: ./.github/workflows/build.yml
    with:
      runner: ubuntu-latest
      java: ${{ matrix.java }}
      native: gtk.linux.x86_64
      gtk: ${{ matrix.gtk }}
      gdk_backend: ${{ matrix.gdk_backend }}
      performance: ${{ contains(github.event.pull_request.labels.*.name, 'performance') }}
      runtodotests: ${{ contains(github.event.pull_request.labels.*.name, 'runtodotests') }}

  build-windows:
    name: Build (Windows)
    needs: changes
    # push => always; PR => run if win32 changed OR "other" changed (run-everything case)
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.win32 == 'true' || needs.changes.outputs.other == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        java: ['21']
    uses: ./.github/workflows/build.yml
    with:
      runner: windows-latest
      java: ${{ matrix.java }}
      native: win32.win32.x86_64
      performance: ${{ contains(github.event.pull_request.labels.*.name, 'performance') }}
      runtodotests: ${{ contains(github.event.pull_request.labels.*.name, 'runtodotests') }}

  build-macos:
    name: Build (macOS)
    needs: changes
    # push => always; PR => run if cocoa changed OR "other" changed (run-everything case)
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.cocoa == 'true' || needs.changes.outputs.other == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        java: ['21']
        arch: [x86_64, aarch64]
    uses: ./.github/workflows/build.yml
    with:
      runner: ${{ matrix.arch == 'x86_64' && 'macos-15-intel' || 'macos-latest' }}
      java: ${{ matrix.java }}
      native: ${{ matrix.arch == 'x86_64' && 'cocoa.macosx.x86_64' || 'cocoa.macosx.aarch64' }}
      performance: ${{ contains(github.event.pull_request.labels.*.name, 'performance') }}
      runtodotests: ${{ contains(github.event.pull_request.labels.*.name, 'runtodotests') }}
